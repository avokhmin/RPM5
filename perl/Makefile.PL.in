use ExtUtils::MakeMaker;
# See lib/ExtUtils/MakeMaker.pm for details of how to influence
# the contents of the Makefile that is written.

my @libdir = qw(. build lib popt rpmdb rpmio misc rpmconstant);

my @ldaddp = map { '-L@top_srcdir@/' . $_ . '/.libs' } @libdir;
my @ldadd = map { '-l' . $_ } qw(rpmmisc rpmio rpmbuild rpm popt rpmdb rpmconstant);

my @objects = qw(
    rpmxs.o 
    RPM.o 
    RPM_Constant.o
    RPM_Header.o
    RPM_Transaction.o
    RPM_PackageIterator.o
    RPM_Problems.o
    RPM_Spec.o
    RPM_Files.o
    RPM_Dependencies.o
);

# teach MakeMaker some Mac OS X LDFLAGS:
my @LDFLAGS = qw(@LDFLAGS@);
foreach (@LDFLAGS) {
    if (m/-arch|ppc|i386|ppc64|x86_64/) {
         push (@ldflags, $&);
    } elsif (m/-Wl,-search_paths_first/) {
         push (@ldflags, $&);
    } else {
         push (@ldlibs, $_);    
    }
}

WriteMakefile(
	      'NAME'	=> 'RPM',
	      'OBJECT'	=> join(' ', @objects),
	      'VERSION' => '@VERSION@',
	      'MAKEFILE'=> 'Makefile.perl',
	      'LIBS'	=> [join(' ', @ldaddp) . ' ' . join(' ', @ldadd) . ' ' . join(' ', @ldlibs) . ' @LIBS@'],
	      'CCFLAGS' => '@CFLAGS@',
	      'LDFLAGS'	=> join(' ', @ldflags),
	      'dynamic_lib'	=> { OTHERLDFLAGS => join(' ', @ldflags) },
	      'OPTIMIZE'=> '-g',
	      'INC'	=> join(' ', map { '-I@top_srcdir@/'. $_ } @libdir) . ' @CPPFLAGS@',
);

