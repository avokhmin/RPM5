LIBOBJECTS = header.o oldrpmdb.o misc.o messages.o rpmerr.o falloc.o \
	     var.o md5.o md5sum.o dbindex.o rpmrc.o depends.o \
	     rpmdb.o stringbuf.o rpmlead.o package.o uninstall.o \
	     oldheader.o install.o signature.o verify.o 
SOURCES = $(subst .o,.c,$(LIBOBJECTS)) 
TAGTABLE = tagtable.o
LIBRPM = librpm.a
LOADLIBES = -lrpm -lgdbm -ldb $(LIBEFENCE)
PROGS = 
AR = ar

# -----------------------------------------------------------------------

ifeq (.depend,$(wildcard .depend))
TARGET=allprogs
else
TARGET=depend allprogs
endif

all: $(TARGET)

allprogs: $(LIBRPM) $(PROGS)

$(PROGS): $(LIBRPM)

$(LIBRPM): $(LIBRPM)($(LIBOBJECTS) $(TAGTABLE))
	$(RANLIB) $@

tagtable.c: rpmlib.h Makefile
	echo '#include "rpmlib.h"' > tagtable.c
	echo '' >> tagtable.c
	echo 'const struct rpmTagTableEntry rpmTagTable[] = {' >> tagtable.c
	awk '/(RPMTAG_[A-Z0-9]*)[ \t]+([0-9]*)/ { printf("\t{ \"%s\", %s },\n", $$2, $$3); }' < rpmlib.h >> tagtable.c
	echo '};' >> tagtable.c
	echo '' >> tagtable.c
	echo 'const int rpmTagTableSize = sizeof(rpmTagTable) / sizeof(struct rpmTagTableEntry);' >> tagtable.c

install:
	install -m 755 -o 0 -g 0 -d $(INCDIR)
	install -m 755 -o 0 -g 0 -d $(LIBDIR)
	install -m 644 -o 0 -g 0 rpmlib.h $(INCDIR)
	install -m 644 -o 0 -g 0 dbindex.h $(INCDIR)
	install -m 644 -o 0 -g 0 header.h $(INCDIR)
	install -m 644 -o 0 -g 0 messages.h $(INCDIR)
	install -m 644 -o 0 -g 0 rpmerr.h $(INCDIR)
	install -m 644 -o 0 -g 0 librpm.a $(LIBDIR)

clean:
	rm -f *.a *.o *~ $(PROGS) test.out tagtable.c

squeaky: clean
	rm -f depend

depend:
	$(CPP) $(CFLAGS) -M $(SOURCES) > .depend

ifeq (.depend,$(wildcard .depend))
include .depend
endif
